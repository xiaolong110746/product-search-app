<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>å•†å“æŸ¥è¯¢ç³»ç»Ÿ - è‡ªåŠ¨è®°å¿†ç‰ˆ</title>
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å•†å“æŸ¥è¯¢">
    <link rel="apple-touch-icon" href="icon-192.png">
    
   <!-- AG Grid æ ¸å¿ƒæ ·å¼ -->
   <link rel="stylesheet" href="ag-grid-community-31.0.3/package/styles/ag-grid.min.css">
   <link rel="stylesheet" href="ag-grid-community-31.0.3/package/styles/ag-theme-alpine.min.css">
   <!-- AG Grid æ ¸å¿ƒåº“ -->
   <script src="ag-grid-community-31.0.3/package/dist/ag-grid-community.min.js"></script>
   <!-- Excel è§£æåº“ -->
   <script src="xlsx.full.min.js"></script>
   <!-- æ‹¼éŸ³åº“ -->
   <script src="pinyin-pro.min.js"></script>
    
    <style>
        :root { --primary-color: #2563eb; --bg-color: #f1f5f9; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; width: 100%; overflow: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); display: flex; flex-direction: column; padding: 8px; }
        .container { flex: 1; display: flex; flex-direction: column; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 12px; min-height: 0; overflow: hidden; width: 100%; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 12px; flex-shrink: 0; }
        h1 { margin: 0; font-size: 1.5rem; color: #0f172a; }
        .subtitle { font-size: 0.9rem; color: #64748b; margin-top: 2px; }
        
        .btn { padding: 10px 16px; border-radius: 8px; font-size: 0.95rem; font-weight: 500; cursor: pointer; border: 1px solid #e2e8f0; background: white; color: #475569; transition: all 0.2s; }
        .btn:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-primary { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-danger { color: #dc2626; border-color: #fca5a5; }
        .btn-danger:hover { background: #fef2f2; }
        #fileInput { display: none; }
        
        .search-box { display: flex; gap: 12px; margin-bottom: 12px; align-items: center; position: relative; flex-shrink: 0; }
        .search-input { flex: 1; padding: 12px 16px; font-size: 1.1rem; border: 2px solid #e2e8f0; border-radius: 8px; outline: none; transition: all 0.2s; }
        .search-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }
        
        /* çŠ¶æ€å¾½ç« æ ·å¼ */
        .status-badge {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 18px; border-radius: 20px;
            font-size: 1.1rem; font-weight: 600;
            opacity: 0; visibility: hidden; 
            transition: all 0.2s ease;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }

        .status-badge.visible {
            opacity: 1;
            visibility: visible;
        }

        .status-badge.found {
            background-color: #dcfce7;
            color: #15803d;
            box-shadow: 0 2px 8px rgba(21, 128, 61, 0.2);
        }

        .status-badge.notfound {
            background-color: #fee2e2;
            color: #dc2626;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
        }
        
        .grid-container { flex: 1; min-height: 0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; width: 100%; }
        
        /* AG Grid è¡¨æ ¼å­—ä½“æ”¾å¤§ */
        .ag-theme-alpine { font-size: 16px; }
        .ag-theme-alpine .ag-header-cell-label { justify-content: center; }
        .ag-theme-alpine .ag-header-cell-text { font-size: 16px; font-weight: 600; }
        .ag-theme-alpine .ag-cell { font-size: 16px; }
        .ag-theme-alpine .ag-cell-value { display: flex; align-items: center; justify-content: center; }
        
        /* è¡Œé€‰ä¸­é«˜äº®æ ·å¼ */
        .ag-theme-alpine .ag-row-selected { background-color: #dbeafe !important; }
        .ag-theme-alpine .ag-row-selected:hover { background-color: #bfdbfe !important; }
        .ag-theme-alpine .ag-row:hover { background-color: #f1f5f9; }
        
        .highlight-text { background-color: #fef08a; color: #854d0e; padding: 0 4px; border-radius: 2px; font-weight: bold; }
        
        .footer { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 1rem; color: #64748b; flex-wrap: wrap; gap: 8px; flex-shrink: 0; }
        
        /* æç¤ºä¿¡æ¯æ ·å¼ */
        .info-box {
            margin-top: 8px;
            padding: 10px 14px;
            background-color: #dbeafe;
            border-radius: 8px;
            font-size: 0.95rem;
            color: #1e40af;
            line-height: 1.5;
            flex-shrink: 0;
        }
        .info-box.success { background-color: #dcfce7; color: #166534; }
        .info-box.warning { background-color: #fef3c7; color: #92400e; }
        .info-box.error { background-color: #fee2e2; color: #991b1b; }
        
        .file-name { font-weight: 600; }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading { 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            padding: 20px; color: #64748b;
        }
        
        /* ç­›é€‰çŠ¶æ€æç¤ºåŒº */
        .filter-status {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin-bottom: 10px;
            background-color: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #92400e;
            flex-wrap: wrap;
            flex-shrink: 0;
            min-height: 44px;
        }
        .filter-status.visible {
            display: flex;
        }
        .filter-status .filter-tags-container {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-wrap: nowrap;
            gap: 6px;
            align-items: center;
            overflow: hidden;
            height: 28px;
        }
        
        /* ç­›é€‰æ ‡ç­¾æ ·å¼ - å¢å¼ºäº¤äº’ */
        .filter-status .filter-tag {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            background-color: #fff;
            border-radius: 4px;
            font-size: 0.9rem;
            flex-shrink: 1;
            min-width: 60px;
            height: 28px;
            position: relative;
            cursor: pointer;
            transition: box-shadow 0.2s ease;
            user-select: none;
            overflow: hidden;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .filter-status .filter-tag.search {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .filter-status .filter-tag.column {
            background-color: #dcfce7;
            color: #166534;
        }
        
        /* æ‚¬åœæ•ˆæœ */
        .filter-status .filter-tag:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }
        
        /* å…³é—­æŒ‰é’®é®ç½©å±‚ */
        .filter-status .filter-tag::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            z-index: 1;
        }
        
        .filter-status .filter-tag:hover::before {
            opacity: 1;
        }
        
        /* å…³é—­æŒ‰é’®å›¾æ ‡ */
        .filter-status .filter-tag::after {
            content: 'âœ•';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            opacity: 0;
            transition: all 0.2s ease;
            pointer-events: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
            z-index: 3;
            background-color: rgba(220, 38, 38, 0.9);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .filter-status .filter-tag:hover::after {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        /* æ ‡ç­¾æ–‡å­—ä¿æŒåœ¨æœ€ä¸Šå±‚ */
        .filter-status .filter-tag .tag-text {
            transition: opacity 0.2s ease;
            position: relative;
            z-index: 2;
            white-space: nowrap;
        }
        
        /* æ‚¬åœæ—¶æ–‡å­—ä¿æŒå¯è§ */
        
        /* åˆ é™¤åŠ¨ç”» - ç¼©å°æ¶ˆå¤± */
        .filter-status .filter-tag.removing {
            pointer-events: none;
            animation: tagRemove 0.35s ease-out forwards;
        }
        
        @keyframes tagRemove {
            0% {
                opacity: 1;
                transform: scaleX(1);
                max-width: 300px;
                padding: 4px 10px;
                margin-right: 6px;
            }
            40% {
                opacity: 0.8;
                transform: scaleX(0.8);
            }
            100% {
                opacity: 0;
                transform: scaleX(0);
                max-width: 0;
                padding-left: 0;
                padding-right: 0;
                margin-right: 0;
            }
        }
        
        .filter-status .clear-btn {
            padding: 6px 14px;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        .filter-status .btn-group {
            margin-left: auto;
            display: flex;
            gap: 4px;
        }
        .filter-status .clear-btn.search {
            background-color: #fca5a5;
            color: #991b1b;
        }
        .filter-status .clear-btn.search:hover {
            background-color: #f87171;
            color: white;
        }
        .filter-status .clear-btn.filter {
            background-color: #f87171;
        }
        .filter-status .clear-btn.filter:hover {
            background-color: #ef4444;
        }
        .filter-status .clear-btn.all {
            background-color: #dc2626;
        }
        .filter-status .clear-btn.all:hover {
            background-color: #b91c1c;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>ğŸ“¦ å•†å“æŸ¥è¯¢ç³»ç»Ÿ</h1>
            <div class="subtitle">æ‰«ç æ£€æµ‹ | é”®ç›˜å›¾æ ‡ | æ•°å­—æ’åº | <b style="color: #16a34a;">è‡ªåŠ¨è®°å¿†æ–‡ä»¶</b></div>
        </div>
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="triggerFileSelect()">ğŸ“‚ å¯¼å…¥ Excel</button>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
            <button class="btn" onclick="autoSizeAll()">â†”ï¸ è‡ªåŠ¨åˆ—å®½</button>
            <button class="btn btn-danger" onclick="clearSavedData()">ğŸ—‘ï¸ æ¸…é™¤è®°å¿†</button>
        </div>
    </header>

    <div class="search-box">
        <input type="text" id="searchInput" class="search-input" placeholder="æ‰«ç æˆ–è¾“å…¥åç§°/æ‹¼éŸ³..." autofocus>
        <div id="statusBadge" class="status-badge">
            <span id="iconSpan"></span>
            <span id="statusText"></span>
        </div>
    </div>
    
    <!-- ç­›é€‰çŠ¶æ€æç¤ºåŒº -->
    <div id="filterStatus" class="filter-status">
        <span>ğŸ” å½“å‰æ“ä½œï¼š</span>
        <div id="filterTags" class="filter-tags-container"></div>
        <div class="btn-group">
            <button class="clear-btn search" onclick="clearSearchOnly()">æ¸…é™¤æœç´¢</button>
            <button class="clear-btn filter" onclick="clearFilterOnly()">æ¸…é™¤ç­›é€‰</button>
            <button class="clear-btn all" onclick="clearAllFilters()">æ¸…é™¤å…¨éƒ¨</button>
        </div>
    </div>

    <div id="myGrid" class="grid-container ag-theme-alpine">
        <div class="loading" id="loadingIndicator">æ­£åœ¨åŠ è½½...</div>
    </div>

    <div class="footer">
        <span id="dataSource">å½“å‰æ•°æ®ï¼šåŠ è½½ä¸­...</span>
        <span id="recordCount">å…± 0 æ¡</span>
    </div>
    
    <div class="info-box" id="infoBox">
        ğŸ’¡ ç‚¹å‡»ã€ŒğŸ“‚ å¯¼å…¥ Excelã€æŒ‰é’®å¯¼å…¥å•†å“æ•°æ®ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®°ä½æ‚¨é€‰æ‹©çš„æ–‡ä»¶ã€‚
    </div>
</div>

<script>
// ==========================================
// å…¨å±€çŠ¶æ€
// ==========================================
let gridApi = null;
let allData = [];
let currentSearchText = ''; 
let lastFilteredCount = 0; // è®°å½•ä¸Šæ¬¡ç­›é€‰ç»“æœæ•°é‡

// å­˜å‚¨é”®å
const STORAGE_KEY = 'product_query_excel_data';

// ==========================================
// å­˜å‚¨å‡½æ•° - ä½¿ç”¨ localStorage
// ==========================================
function saveData(fileName, arrayBuffer, recordCount) {
    try {
        // å°† ArrayBuffer è½¬ä¸º Base64 å­—ç¬¦ä¸²
        const base64 = arrayBufferToBase64(arrayBuffer);
        
        const data = {
            fileName: fileName,
            fileData: base64,
            recordCount: recordCount,
            savedAt: new Date().toISOString()
        };
        
        // localStorage æœ‰å¤§å°é™åˆ¶ï¼ˆçº¦5MBï¼‰ï¼Œå¦‚æœæ•°æ®å¤ªå¤§éœ€è¦åˆ†ç‰‡
        const jsonStr = JSON.stringify(data);
        
        // æ£€æŸ¥å¤§å°
        if (jsonStr.length > 4 * 1024 * 1024) { // 4MB è­¦å‘Šé˜ˆå€¼
            console.warn('âš ï¸ æ–‡ä»¶è¾ƒå¤§ï¼Œå¯èƒ½è¶…å‡ºå­˜å‚¨é™åˆ¶');
        }
        
        localStorage.setItem(STORAGE_KEY, jsonStr);
        console.log('âœ… æ•°æ®å·²ä¿å­˜åˆ° localStorage:', fileName);
        return true;
    } catch (e) {
        console.error('âŒ ä¿å­˜å¤±è´¥:', e);
        
        // å¦‚æœæ˜¯é…é¢è¶…é™é”™è¯¯
        if (e.name === 'QuotaExceededError' || e.code === 22) {
            showToast('âš ï¸ æ–‡ä»¶å¤ªå¤§ï¼Œè¶…å‡ºæµè§ˆå™¨å­˜å‚¨é™åˆ¶ï¼Œæ— æ³•è®°ä½æ­¤æ–‡ä»¶');
        }
        return false;
    }
}

function loadData() {
    try {
        const jsonStr = localStorage.getItem(STORAGE_KEY);
        if (!jsonStr) return null;
        
        const data = JSON.parse(jsonStr);
        // Base64 è½¬ ArrayBuffer
        data.fileData = base64ToArrayBuffer(data.fileData);
        console.log('âœ… ä» localStorage åŠ è½½æ•°æ®:', data.fileName);
        return data;
    } catch (e) {
        console.error('âŒ åŠ è½½å¤±è´¥:', e);
        return null;
    }
}

function clearData() {
    try {
        localStorage.removeItem(STORAGE_KEY);
        console.log('âœ… å·²æ¸…é™¤ä¿å­˜çš„æ•°æ®');
        return true;
    } catch (e) {
        console.error('âŒ æ¸…é™¤å¤±è´¥:', e);
        return false;
    }
}

// ArrayBuffer è½¬ Base64
function arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
}

// Base64 è½¬ ArrayBuffer
function base64ToArrayBuffer(base64) {
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
    }
    return bytes.buffer;
}

// ==========================================
// æ™ºèƒ½é«˜äº®æ¸²æŸ“å™¨ - ç”¨äºæ–‡æœ¬æ ¼å¼åˆ—
// ==========================================
class SmartHighlightRenderer {
    init(params) {
        this.eGui = document.createElement('span');
        this.refresh(params);
    }

    getGui() { return this.eGui; }

    refresh(params) {
        const text = String(params.value || '');
        const search = currentSearchText.toLowerCase().trim();
        
        if (!search) {
            this.eGui.innerHTML = this.escapeHtml(text);
            return true;
        }

        const lowerText = text.toLowerCase();
        const directIndex = lowerText.indexOf(search);
        
        if (directIndex !== -1) {
            const before = text.substring(0, directIndex);
            const match = text.substring(directIndex, directIndex + search.length);
            const after = text.substring(directIndex + search.length);
            this.eGui.innerHTML = `${this.escapeHtml(before)}<span class="highlight-text">${this.escapeHtml(match)}</span>${this.escapeHtml(after)}`;
            return true;
        }

        // æ‹¼éŸ³åŒ¹é…
        if (params.colDef.field === 'name' && params.data && params.data._pinyinFull) {
            const pinyinFull = params.data._pinyinFull;
            const pinyinIndex = pinyinFull.indexOf(search);
            if (pinyinIndex !== -1) {
                const start = pinyinIndex;
                const end = start + search.length;
                const before = text.substring(0, start);
                const match = text.substring(start, end);
                const after = text.substring(end);
                this.eGui.innerHTML = `${this.escapeHtml(before)}<span class="highlight-text">${this.escapeHtml(match)}</span>${this.escapeHtml(after)}`;
                return true;
            }
        }

        this.eGui.innerHTML = this.escapeHtml(text);
        return true;
    }

    escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
        }[m]));
    }
}

// ==========================================
// æ•°å­—æ ¼å¼æ¸²æŸ“å™¨ - ç”¨äºæ•°å­—æ ¼å¼åˆ—ï¼ˆæ”¯æŒé«˜äº®ï¼‰
// ==========================================
class NumericRenderer {
    init(params) {
        this.eGui = document.createElement('span');
        this.refresh(params);
    }

    getGui() { return this.eGui; }

    refresh(params) {
        const value = params.value;
        const search = currentSearchText.toLowerCase().trim();
        
        if (value === null || value === undefined || value === '') {
            this.eGui.innerHTML = '';
            return true;
        }
        
        // ç›´æ¥ä½¿ç”¨æ•°å­—å€¼ï¼Œæ ¼å¼åŒ–ä¸º1ä½å°æ•°
        let displayText;
        if (typeof value === 'number') {
            displayText = value.toFixed(1);
        } else {
            const num = parseFloat(value);
            displayText = isNaN(num) ? String(value) : num.toFixed(1);
        }
        
        if (!search) {
            this.eGui.innerHTML = this.escapeHtml(displayText);
            return true;
        }
        
        // é«˜äº®åŒ¹é…
        const lowerText = displayText.toLowerCase();
        const index = lowerText.indexOf(search);
        
        if (index !== -1) {
            const before = displayText.substring(0, index);
            const match = displayText.substring(index, index + search.length);
            const after = displayText.substring(index + search.length);
            this.eGui.innerHTML = `${this.escapeHtml(before)}<span class="highlight-text">${this.escapeHtml(match)}</span>${this.escapeHtml(after)}`;
        } else {
            this.eGui.innerHTML = this.escapeHtml(displayText);
        }
        return true;
    }

    escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
        }[m]));
    }
}

// ==========================================
// Grid é…ç½®
// ==========================================
const numericComparator = (valueA, valueB) => {
    const valA = parseFloat(valueA) || 0;
    const valB = parseFloat(valueB) || 0;
    return valA - valB;
};

const columnDefs = [
    { field: 'name', headerName: 'å•†å“åç§°', minWidth: 80, pinned: 'left', cellRenderer: SmartHighlightRenderer, tooltipField: 'name' },
    { field: 'cost', headerName: 'è¿›ä»·ï¼ˆæ¡ï¼‰', minWidth: 70, cellRenderer: NumericRenderer, comparator: numericComparator, filter: 'agNumberColumnFilter' },
    { field: 'priceStrip', headerName: 'å”®ä»·ï¼ˆæ¡ï¼‰', minWidth: 70, cellRenderer: NumericRenderer, comparator: numericComparator, filter: 'agNumberColumnFilter' },
    { field: 'suggestStrip', headerName: 'å»ºè®®ä»·ï¼ˆæ¡ï¼‰', minWidth: 80, cellRenderer: NumericRenderer, comparator: numericComparator, filter: 'agNumberColumnFilter' },
    { field: 'pricePack', headerName: 'å”®ä»·ï¼ˆåŒ…ï¼‰', minWidth: 70, cellRenderer: NumericRenderer, comparator: numericComparator, filter: 'agNumberColumnFilter' },
    { field: 'suggestPack', headerName: 'å»ºè®®ä»·ï¼ˆåŒ…ï¼‰', minWidth: 80, cellRenderer: NumericRenderer, comparator: numericComparator, filter: 'agNumberColumnFilter' },
    { field: 'barcodeStrip', headerName: 'æ¡ç ', minWidth: 90, cellRenderer: SmartHighlightRenderer },
    { field: 'barcodePack', headerName: 'åŒ…ç ', minWidth: 90, cellRenderer: SmartHighlightRenderer }
];

const gridOptions = {
    columnDefs: columnDefs,
    rowData: [],
    defaultColDef: { resizable: true, sortable: true },
    rowSelection: 'single',
    suppressRowClickSelection: false,
    onFilterChanged: function() {
        updateFilterStatus();
        // åŒæ­¥æ›´æ–°é¡µè„šçš„è®°å½•æ•°
        updateFooterCount();
    },
    localeText: {
        noRowsToShow: 'æš‚æ— æ•°æ®',
        // èœå•ç›¸å…³
        pinColumn: 'å›ºå®šåˆ—',
        pinLeft: 'å›ºå®šåˆ°å·¦ä¾§',
        pinRight: 'å›ºå®šåˆ°å³ä¾§',
        noPin: 'ä¸å›ºå®š',
        valueAggregation: 'å€¼èšåˆ',
        autosizeThiscolumn: 'è‡ªåŠ¨è°ƒæ•´æ­¤åˆ—å®½åº¦',
        autosizeAllColumns: 'è‡ªåŠ¨è°ƒæ•´æ‰€æœ‰åˆ—å®½åº¦',
        groupBy: 'åˆ†ç»„',
        ungroupBy: 'å–æ¶ˆåˆ†ç»„',
        resetColumns: 'é‡ç½®åˆ—',
        expandAll: 'å±•å¼€å…¨éƒ¨',
        collapseAll: 'æŠ˜å å…¨éƒ¨',
        copy: 'å¤åˆ¶',
        ctrlC: 'Ctrl+C',
        copyWithHeaders: 'å¤åˆ¶(å«è¡¨å¤´)',
        paste: 'ç²˜è´´',
        ctrlV: 'Ctrl+V',
        export: 'å¯¼å‡º',
        csvExport: 'å¯¼å‡ºCSV',
        excelExport: 'å¯¼å‡ºExcel',
        // ç­›é€‰ç›¸å…³
        filterOoo: 'ç­›é€‰...',
        equals: 'ç­‰äº',
        notEqual: 'ä¸ç­‰äº',
        lessThan: 'å°äº',
        greaterThan: 'å¤§äº',
        lessThanOrEqual: 'å°äºæˆ–ç­‰äº',
        greaterThanOrEqual: 'å¤§äºæˆ–ç­‰äº',
        inRange: 'èŒƒå›´å†…',
        inRangeStart: 'ä»',
        inRangeEnd: 'åˆ°',
        contains: 'åŒ…å«',
        notContains: 'ä¸åŒ…å«',
        startsWith: 'å¼€å¤´ä¸º',
        endsWith: 'ç»“å°¾ä¸º',
        blank: 'ç©ºç™½',
        notBlank: 'éç©ºç™½',
        andCondition: 'å¹¶ä¸”',
        orCondition: 'æˆ–è€…',
        applyFilter: 'åº”ç”¨',
        resetFilter: 'é‡ç½®',
        clearFilter: 'æ¸…é™¤ç­›é€‰',
        // æ’åºç›¸å…³
        sortAscending: 'å‡åºæ’åº',
        sortDescending: 'é™åºæ’åº',
        sortUnSort: 'å–æ¶ˆæ’åº',
        // å…¶ä»–
        loadingOoo: 'åŠ è½½ä¸­...',
        selectAll: 'å…¨é€‰',
        selectAllSearchResults: 'é€‰æ‹©æ‰€æœ‰æœç´¢ç»“æœ',
        searchOoo: 'æœç´¢...',
        blanks: 'ç©ºç™½',
        noMatches: 'æ— åŒ¹é…é¡¹',
        group: 'åˆ†ç»„',
        ungroup: 'å–æ¶ˆåˆ†ç»„',
        columns: 'åˆ—',
        filters: 'ç­›é€‰',
        pivotMode: 'é€è§†æ¨¡å¼',
        groups: 'åˆ†ç»„',
        rowGroupColumnsEmptyMessage: 'æ‹–æ‹½æ­¤å¤„è®¾ç½®åˆ†ç»„',
        values: 'å€¼',
        pivotColumns: 'é€è§†åˆ—',
        pivotColumnsEmptyMessage: 'æ‹–æ‹½æ­¤å¤„è®¾ç½®é€è§†'
    }
};

// ==========================================
// æ•°æ®å¤„ç†å‡½æ•°
// ==========================================
function processPinyin(text) {
    if (!text) return '';
    if (typeof pinyinPro !== 'undefined') {
        try {
            return pinyinPro.pinyin(text, { pattern: 'first', toneType: 'none' }).replace(/\s/g, '').toLowerCase();
        } catch (e) {
            return '';
        }
    }
    return '';
}

function parseExcelData(arrayBuffer) {
    try {
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        
        return jsonData.map(row => {
            const clean = {};
            Object.keys(row).forEach(k => clean[k.trim()] = row[k]);
            const get = keys => { for (let k of keys) if (clean[k]) return clean[k]; return ''; };
            const getNum = keys => {
                const val = get(keys);
                if (val === '' || val === null || val === undefined) return null;
                const num = parseFloat(val);
                return isNaN(num) ? null : num;
            };
            
            return {
                name: get(['å•†å“åç§°', 'å“å', 'åç§°']),
                cost: getNum(['è¿›ä»·ï¼ˆæ¡ï¼‰', 'è¿›ä»·']),
                priceStrip: getNum(['å”®ä»·ï¼ˆæ¡ï¼‰', 'æ¡å”®ä»·']),
                suggestStrip: getNum(['å»ºè®®ä»·ï¼ˆæ¡ï¼‰']),
                pricePack: getNum(['å”®ä»·ï¼ˆåŒ…ï¼‰', 'åŒ…å”®ä»·']),
                suggestPack: getNum(['å»ºè®®ä»·ï¼ˆåŒ…ï¼‰']),
                barcodeStrip: get(['æ¡ç ï¼ˆæ¡ï¼‰', 'æ¡ç ', 'å•†å“æ¡ç ', 'æ¡å½¢ç ', 'æ¡ç (æ¡)']),
                barcodePack: get(['æ¡ç ï¼ˆåŒ…ï¼‰', 'åŒ…ç ', 'æ¡ç (åŒ…)', 'åŒ…æ¡ç ', 'åŒ…çš„æ¡ç '])
            };
        }).filter(item => item.name || item.barcodeStrip || item.barcodePack);
    } catch (e) {
        console.error('è§£æExcelå¤±è´¥:', e);
        return [];
    }
}

function processData(data, source) {
    // æ·»åŠ æ‹¼éŸ³
    data.forEach(item => {
        item._pinyinFull = processPinyin(item.name);
        item.namePinyin = item._pinyinFull;
    });
    
    allData = data;
    
    if (gridApi) {
        gridApi.setGridOption('rowData', allData);
        // è‡ªåŠ¨è°ƒæ•´åˆ—å®½é€‚åº”å†…å®¹
        setTimeout(() => {
            gridApi.autoSizeAllColumns();
        }, 100);
    }
    
    document.getElementById('dataSource').innerHTML = `æ•°æ®ï¼š<span class="file-name">${source}</span>`;
    document.getElementById('recordCount').textContent = `å…± ${data.length} æ¡`;
}

// ==========================================
// æ–‡ä»¶ä¸Šä¼ å¤„ç†
// ==========================================
function triggerFileSelect() {
    document.getElementById('fileInput').click();
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // å…ˆæ¸…é™¤æœç´¢å’Œç­›é€‰
    input.value = '';
    currentSearchText = '';
    if (gridApi) {
        gridApi.setFilterModel(null);
    }
    // éšè—ç­›é€‰çŠ¶æ€æç¤ºåŒº
    document.getElementById('filterStatus').classList.remove('visible');
    hideStatus();
    
    showToast('ğŸ“– æ­£åœ¨è¯»å–æ–‡ä»¶...');
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const arrayBuffer = e.target.result;
            const formatted = parseExcelData(arrayBuffer);
            
            if (formatted.length === 0) {
                showToast('âŒ æ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                return;
            }
            
            // æ˜¾ç¤ºæ•°æ®
            processData(formatted, file.name);
            
            // ä¿å­˜åˆ° localStorage
            const saved = saveData(file.name, arrayBuffer, formatted.length);
            
            if (saved) {
                updateInfoBox(true, file.name, formatted.length);
                showToast(`âœ… å·²å¯¼å…¥å¹¶è®°ä½ã€Œ${file.name}ã€ï¼Œå…± ${formatted.length} æ¡`);
            } else {
                updateInfoBox(false);
                showToast(`âœ… å¯¼å…¥æˆåŠŸï¼Œä½†æ–‡ä»¶å¤ªå¤§æ— æ³•è®°ä½`);
            }
            
        } catch (err) {
            console.error('è§£æå¤±è´¥:', err);
            showToast('âŒ è§£æå¤±è´¥: ' + err.message);
        }
    };
    
    reader.onerror = function() {
        showToast('âŒ æ–‡ä»¶è¯»å–å¤±è´¥');
    };
    
    reader.readAsArrayBuffer(file);
    event.target.value = '';
}

// ==========================================
// æœç´¢ä¸æ‰«ç é€»è¾‘
// ==========================================
const input = document.getElementById('searchInput');
const badge = document.getElementById('statusBadge');
const iconSpan = document.getElementById('iconSpan');
const statusText = document.getElementById('statusText');

let notFoundTimer = null; // ç”¨äºæœªæ‰¾åˆ°æ—¶è‡ªåŠ¨æ¢å¤çš„å®šæ—¶å™¨
let searchDebounceTimer = null; // æœç´¢é˜²æŠ–å®šæ—¶å™¨

function initScannerLogic() {
    input.addEventListener('input', (e) => {
        const val = e.target.value;

        // å¦‚æœæœ‰æ–°çš„è¾“å…¥ï¼Œå–æ¶ˆä¹‹å‰çš„æœªæ‰¾åˆ°æ¢å¤å®šæ—¶å™¨
        if (notFoundTimer) {
            clearTimeout(notFoundTimer);
            notFoundTimer = null;
        }

        // é˜²æŠ–ï¼šåœæ­¢è¾“å…¥256msåæ‰æ‰§è¡Œæœç´¢
        if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            filterData(val);
            searchDebounceTimer = null;
        }, 256);
    });
}

function filterData(query) {
    if (!gridApi) return;
    currentSearchText = query;
    
    if (!query.trim()) {
        gridApi.setGridOption('rowData', allData);
        updateCount(allData.length);
        lastFilteredCount = allData.length;
        hideStatus();
        updateFilterStatus();
        return;
    }
    
    const q = query.toLowerCase();
    const filtered = allData.filter(item => {
        const hasText = Object.values(item).some(val => String(val).toLowerCase().includes(q));
        const hasPinyin = item.namePinyin && item.namePinyin.includes(q);
        return hasText || hasPinyin;
    });
    
    gridApi.setGridOption('rowData', filtered);
    lastFilteredCount = filtered.length;
    updateCount(filtered.length);
    
    // å®æ—¶æ˜¾ç¤ºæ‰¾åˆ°çš„ç»“æœæ•°é‡æˆ–æœªæ‰¾åˆ°æç¤º
    if (filtered.length > 0) {
        showFoundStatus(filtered.length);
    } else {
        showNotFoundStatus();
    }
    
    updateFilterStatus();
}

function updateCount(n) { 
    document.getElementById('recordCount').textContent = `å½“å‰: ${n} æ¡`; 
}

// æ›´æ–°é¡µè„šè®°å½•æ•°ï¼ˆæ ¹æ®å½“å‰è¡¨æ ¼æ˜¾ç¤ºçš„è¡Œæ•°ï¼‰
function updateFooterCount() {
    if (gridApi) {
        const displayedCount = gridApi.getDisplayedRowCount();
        document.getElementById('recordCount').textContent = `å½“å‰: ${displayedCount} æ¡`;
    }
}

function clearSearch() {
    // å–æ¶ˆå®šæ—¶å™¨
    if (notFoundTimer) {
        clearTimeout(notFoundTimer);
        notFoundTimer = null;
    }
    
    input.value = '';
    currentSearchText = ''; 
    lastFilteredCount = allData.length;
    if (gridApi) gridApi.setGridOption('rowData', allData);
    updateCount(allData.length);
    input.focus();
    hideStatus();
    updateFilterStatus();
}

function autoSizeAll() { 
    if (gridApi) gridApi.autoSizeAllColumns(); 
}

function showFoundStatus(count) {
    badge.classList.remove('notfound');
    badge.classList.add('visible', 'found');
    iconSpan.textContent = 'âœ…';
    statusText.textContent = `æ‰¾åˆ° ${count} ä¸ª`;
}

function showNotFoundStatus(query) {
    badge.classList.remove('found');
    badge.classList.add('visible', 'notfound');
    iconSpan.textContent = 'âŒ';
    statusText.textContent = 'æœªæ‰¾åˆ°å•†å“';
}

function hideStatus() {
    badge.classList.remove('visible');
}

// ==========================================
// ç­›é€‰çŠ¶æ€æ˜¾ç¤º - å¢å¼ºç‰ˆï¼ˆæ”¯æŒç‚¹å‡»åˆ é™¤ï¼‰
// ==========================================
// åˆ—åæ˜ å°„ï¼ˆè‹±æ–‡å­—æ®µå -> ä¸­æ–‡æ˜¾ç¤ºåï¼‰
const columnNameMap = {
    'name': 'å•†å“åç§°',
    'cost': 'è¿›ä»·ï¼ˆæ¡ï¼‰',
    'priceStrip': 'å”®ä»·ï¼ˆæ¡ï¼‰',
    'suggestStrip': 'å»ºè®®ä»·ï¼ˆæ¡ï¼‰',
    'pricePack': 'å”®ä»·ï¼ˆåŒ…ï¼‰',
    'suggestPack': 'å»ºè®®ä»·ï¼ˆåŒ…ï¼‰',
    'barcodeStrip': 'æ¡ç ',
    'barcodePack': 'åŒ…ç '
};

// ç­›é€‰ç±»å‹æ˜ å°„
const filterTypeMap = {
    'equals': 'ç­‰äº',
    'notEqual': 'ä¸ç­‰äº',
    'lessThan': 'å°äº',
    'greaterThan': 'å¤§äº',
    'lessThanOrEqual': 'å°äºç­‰äº',
    'greaterThanOrEqual': 'å¤§äºç­‰äº',
    'inRange': 'èŒƒå›´',
    'contains': 'åŒ…å«',
    'notContains': 'ä¸åŒ…å«',
    'startsWith': 'å¼€å¤´ä¸º',
    'endsWith': 'ç»“å°¾ä¸º',
    'blank': 'ä¸ºç©º',
    'notBlank': 'ä¸ä¸ºç©º'
};

// å­˜å‚¨å½“å‰ç­›é€‰æ ‡ç­¾çš„ä¿¡æ¯ï¼Œç”¨äºç‚¹å‡»åˆ é™¤
let currentFilterTags = [];

function updateFilterStatus() {
    const filterStatus = document.getElementById('filterStatus');
    const filterTags = document.getElementById('filterTags');
    
    // é‡ç½®æ ‡ç­¾ä¿¡æ¯æ•°ç»„
    currentFilterTags = [];
    let tagsHtml = [];
    
    // æœç´¢æ¡†ç­›é€‰
    if (currentSearchText.trim()) {
        const tagId = 'tag-search';
        currentFilterTags.push({
            id: tagId,
            type: 'search',
            data: currentSearchText.trim()
        });
        tagsHtml.push(`<span class="filter-tag search" id="${tagId}"><span class="tag-text">ğŸ“ æœç´¢"${escapeHtml(currentSearchText.trim())}"</span></span>`);
    }
    
    // AG Grid åˆ—ç­›é€‰
    if (gridApi) {
        const filterModel = gridApi.getFilterModel();
        for (const field in filterModel) {
            const filter = filterModel[field];
            const colName = columnNameMap[field] || field;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªæ¡ä»¶
            if (filter.conditions && filter.conditions.length > 0) {
                // å¤šä¸ªæ¡ä»¶
                const operator = filter.operator === 'AND' ? ' ä¸” ' : ' æˆ– ';
                const conditionTexts = filter.conditions.map(cond => {
                    const filterType = filterTypeMap[cond.type] || cond.type;
                    let filterValue = '';
                    if (cond.type === 'inRange') {
                        filterValue = `${cond.filter} ~ ${cond.filterTo}`;
                    } else if (cond.filter !== undefined) {
                        filterValue = cond.filter;
                    }
                    return `${filterType} ${filterValue}`;
                });
                const tagId = `tag-column-${field}`;
                currentFilterTags.push({
                    id: tagId,
                    type: 'column',
                    data: field
                });
                tagsHtml.push(`<span class="filter-tag column" id="${tagId}"><span class="tag-text">ğŸ” ${colName} ${conditionTexts.join(operator)}</span></span>`);
            } else {
                // å•ä¸ªæ¡ä»¶
                const filterType = filterTypeMap[filter.type] || filter.type;
                let filterValue = '';
                
                if (filter.type === 'inRange') {
                    filterValue = `${filter.filter} ~ ${filter.filterTo}`;
                } else if (filter.filter !== undefined) {
                    filterValue = filter.filter;
                }
                
                const tagId = `tag-column-${field}`;
                currentFilterTags.push({
                    id: tagId,
                    type: 'column',
                    data: field
                });
                tagsHtml.push(`<span class="filter-tag column" id="${tagId}"><span class="tag-text">ğŸ” ${colName} ${filterType} ${filterValue}</span></span>`);
            }
        }
    }
    
    // è·å–å½“å‰æ˜¾ç¤ºçš„è®°å½•æ•°
    let displayedCount = 0;
    if (gridApi) {
        displayedCount = gridApi.getDisplayedRowCount();
    }
    
    // æ˜¾ç¤ºæˆ–éšè—çŠ¶æ€åŒº
    if (tagsHtml.length > 0) {
        filterStatus.classList.add('visible');
        filterTags.innerHTML = tagsHtml.join('');
        
        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        currentFilterTags.forEach(tagInfo => {
            const tagElement = document.getElementById(tagInfo.id);
            if (tagElement) {
                tagElement.addEventListener('click', function() {
                    handleTagClick(tagInfo.id);
                });
            }
        });
    } else {
        filterStatus.classList.remove('visible');
    }
    
    // åŒæ­¥æ›´æ–°é¡µè„šçš„è®°å½•æ•°
    updateFooterCount();
}

// å¤„ç†æ ‡ç­¾ç‚¹å‡» - å¸¦åŠ¨ç”»æ•ˆæœ
function handleTagClick(tagId) {
    const tagInfo = currentFilterTags.find(t => t.id === tagId);
    if (!tagInfo) return;
    
    const tagElement = document.getElementById(tagId);
    if (!tagElement) return;
    
    // æ·»åŠ åˆ é™¤åŠ¨ç”»ç±»
    tagElement.classList.add('removing');
    
    // åŠ¨ç”»ç»“æŸåæ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆåŠ¨ç”»æ—¶é•¿ 0.35sï¼‰
    setTimeout(() => {
        if (tagInfo.type === 'search') {
            // åˆ é™¤æœç´¢æ ‡ç­¾
            clearSearchOnly(true);
            showToast('âœ… å·²åˆ é™¤æœç´¢æ¡ä»¶');
        } else if (tagInfo.type === 'column') {
            // åˆ é™¤åˆ—ç­›é€‰æ ‡ç­¾
            clearColumnFilter(tagInfo.data);
        }
    }, 350);
}

// æ¸…é™¤å•ä¸ªåˆ—çš„ç­›é€‰ï¼ˆå¸¦åŠ¨ç”»åé¦ˆï¼‰
function clearColumnFilter(field) {
    if (gridApi) {
        gridApi.destroyFilter(field);
    }
    
    // å¦‚æœæœç´¢æ¡†æœ‰å†…å®¹ï¼Œé‡æ–°åº”ç”¨æœç´¢
    if (currentSearchText.trim()) {
        filterData(currentSearchText);
    } else if (gridApi) {
        gridApi.setGridOption('rowData', allData);
        updateCount(allData.length);
        lastFilteredCount = allData.length;
    }
    
    updateFilterStatus();
    showToast('âœ… å·²åˆ é™¤æ­¤ç­›é€‰æ¡ä»¶');
}

function clearAllFilters() {
    // æ¸…é™¤æœç´¢æ¡†
    input.value = '';
    currentSearchText = '';
    
    // æ¸…é™¤ AG Grid ç­›é€‰
    if (gridApi) {
        // å…ˆæ¸…é™¤ç­›é€‰æ¨¡å‹
        const filterModel = gridApi.getFilterModel();
        if (Object.keys(filterModel).length > 0) {
            // é€ä¸ªæ¸…é™¤æ¯åˆ—çš„ç­›é€‰å™¨
            Object.keys(filterModel).forEach(field => {
                gridApi.destroyFilter(field);
            });
        }
        gridApi.setGridOption('rowData', allData);
    }
    
    // æ›´æ–°æ˜¾ç¤º
    updateCount(allData.length);
    lastFilteredCount = allData.length;
    hideStatus();
    updateFilterStatus();
    input.focus();
    
    showToast('âœ… å·²æ¸…é™¤æ‰€æœ‰ç­›é€‰æ¡ä»¶');
}

function clearSearchOnly(skipToast = false) {
    // åªæ¸…é™¤æœç´¢æ¡†
    input.value = '';
    currentSearchText = '';
    
    // æ¢å¤åˆ°å…¨éƒ¨æ•°æ®ï¼Œä½†ä¿ç•™åˆ—ç­›é€‰
    if (gridApi) {
        gridApi.setGridOption('rowData', allData);
    }
    
    // æ›´æ–°æ˜¾ç¤º
    updateCount(allData.length);
    lastFilteredCount = allData.length;
    hideStatus();
    updateFilterStatus();
    input.focus();
    
    if (!skipToast) {
        showToast('âœ… å·²æ¸…é™¤æœç´¢æ¡ä»¶');
    }
}

function clearFilterOnly() {
    // åªæ¸…é™¤ AG Grid åˆ—ç­›é€‰
    if (gridApi) {
        const filterModel = gridApi.getFilterModel();
        if (Object.keys(filterModel).length > 0) {
            Object.keys(filterModel).forEach(field => {
                gridApi.destroyFilter(field);
            });
        }
    }
    
    // å¦‚æœæœç´¢æ¡†æœ‰å†…å®¹ï¼Œé‡æ–°åº”ç”¨æœç´¢
    if (currentSearchText.trim()) {
        filterData(currentSearchText);
    } else {
        gridApi.setGridOption('rowData', allData);
        updateCount(allData.length);
        lastFilteredCount = allData.length;
    }
    
    updateFilterStatus();
    
    showToast('âœ… å·²æ¸…é™¤åˆ—ç­›é€‰æ¡ä»¶');
}

function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
    }[m]));
}

// ==========================================
// æç¤ºä¸Toast
// ==========================================
function updateInfoBox(hasFile, fileName, recordCount) {
    const infoBox = document.getElementById('infoBox');
    
    if (hasFile && fileName) {
        infoBox.className = 'info-box success';
        infoBox.innerHTML = `âœ… å·²è‡ªåŠ¨åŠ è½½æ–‡ä»¶ï¼š<b>${fileName}</b>ï¼ˆå…± ${recordCount} æ¡ï¼‰<br>ğŸ’¡ åˆ·æ–°é¡µé¢ä¼šè‡ªåŠ¨åŠ è½½æ­¤æ–‡ä»¶ï¼Œç‚¹å‡»ã€Œå¯¼å…¥ Excelã€å¯æ›´æ¢æ–‡ä»¶ã€‚`;
    } else {
        infoBox.className = 'info-box';
        infoBox.innerHTML = `ğŸ’¡ ç‚¹å‡»ã€ŒğŸ“‚ å¯¼å…¥ Excelã€æŒ‰é’®å¯¼å…¥å•†å“æ•°æ®ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®°ä½æ‚¨é€‰æ‹©çš„æ–‡ä»¶ã€‚<br>ğŸ“‹ æ”¯æŒæ ¼å¼ï¼š.xlsx, .xls, .csvï¼ˆæ–‡ä»¶å¤§å°é™çº¦4MBï¼‰`;
    }
}

function showToast(msg) {
    let t = document.getElementById('toast');
    if(!t) {
        t = document.createElement('div');
        t.id = 'toast';
        t.style.cssText = `position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:14px 28px; border-radius:8px; z-index:9999; opacity:0; transition:opacity 0.3s; font-size:18px; max-width: 90%; text-align: center;`;
        document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.opacity = 1;
    setTimeout(() => t.style.opacity = 0, 3000);
}

// ==========================================
// æ¸…é™¤ä¿å­˜çš„æ•°æ®
// ==========================================
function clearSavedData() {
    if (!confirm('ç¡®å®šè¦æ¸…é™¤å·²ä¿å­˜çš„Excelæ•°æ®å—ï¼Ÿ\næ¸…é™¤åéœ€è¦é‡æ–°å¯¼å…¥æ–‡ä»¶ã€‚')) {
        return;
    }
    
    // æ¸…é™¤ localStorage ä¿å­˜çš„æ•°æ®
    clearData();
    
    // æ¸…é™¤æœç´¢æ¡†
    input.value = '';
    currentSearchText = '';
    
    // æ¸…é™¤ AG Grid ç­›é€‰
    if (gridApi) {
        gridApi.setFilterModel(null);
    }
    
    // æ¸…ç©ºè¡¨æ ¼æ•°æ®
    allData = [];
    if (gridApi) {
        gridApi.setGridOption('rowData', []);
    }
    
    // æ›´æ–°æ˜¾ç¤º
    document.getElementById('dataSource').innerHTML = `æ•°æ®ï¼š<span class="file-name">æœªå¯¼å…¥æ–‡ä»¶</span>`;
    document.getElementById('recordCount').textContent = `å…± 0 æ¡`;
    
    // éšè—ç­›é€‰çŠ¶æ€åŒºå’Œæœç´¢çŠ¶æ€
    document.getElementById('filterStatus').classList.remove('visible');
    hideStatus();
    
    updateInfoBox(false);
    input.focus();
    
    showToast('âœ… å·²æ¸…é™¤ä¿å­˜çš„æ•°æ®');
}

// ==========================================
// æ¸…ç©ºè¡¨æ ¼æ•°æ®
// ==========================================
function loadDemoData() {
    allData = [];
    if (gridApi) {
        gridApi.setGridOption('rowData', []);
    }
    document.getElementById('dataSource').innerHTML = `æ•°æ®ï¼š<span class="file-name">æœªå¯¼å…¥æ–‡ä»¶</span>`;
    document.getElementById('recordCount').textContent = `å…± 0 æ¡`;
}

// ==========================================
// é¡µé¢åˆå§‹åŒ–
// ==========================================
function initApp() {
    console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
    
    // åˆå§‹åŒ– Grid
    const gridDiv = document.querySelector('#myGrid');
    document.getElementById('loadingIndicator').remove();
    gridApi = agGrid.createGrid(gridDiv, gridOptions);
    
    // åˆå§‹åŒ–æ‰«ç é€»è¾‘
    initScannerLogic();
    
    // å°è¯•åŠ è½½å·²ä¿å­˜çš„æ•°æ®
    const savedData = loadData();
    
    if (savedData && savedData.fileData) {
        const formatted = parseExcelData(savedData.fileData);
        
        if (formatted.length > 0) {
            processData(formatted, savedData.fileName);
            updateInfoBox(true, savedData.fileName, formatted.length);
            showToast(`âœ… è‡ªåŠ¨åŠ è½½ã€Œ${savedData.fileName}ã€ï¼Œå…± ${formatted.length} æ¡`);
        } else {
            loadDemoData();
            updateInfoBox(false);
        }
    } else {
        // æ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼ŒåŠ è½½æ¼”ç¤ºæ•°æ®
        loadDemoData();
        updateInfoBox(false);
    }
    
    console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
}

// DOM åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initApp);

// çª—å£å¤§å°å˜åŒ–æ—¶åˆ·æ–° AG Grid å¸ƒå±€
window.addEventListener('resize', function() {
    if (gridApi) {
        // ä½¿ç”¨é˜²æŠ–é¿å…é¢‘ç¹åˆ·æ–°
        clearTimeout(window.resizeTimer);
        window.resizeTimer = setTimeout(function() {
            gridApi.autoSizeAllColumns();
        }, 100);
    }
});

// ==========================================
// Service Worker æ³¨å†Œ
// ==========================================
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(registration => {
                console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
            })
            .catch(err => {
                console.error('âŒ Service Worker æ³¨å†Œå¤±è´¥:', err);
            });
    });
}
</script>
</body>
</html>
